<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üè≠ IoT Bridge Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50, #3498db);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .enhanced-badge {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
        margin-left: 10px;
        box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
      }

      /* Broker Control Section */
      .broker-control-section {
        background: #f8f9fa;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .broker-control {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .broker-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .broker-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #dc3545;
        animation: pulse 2s infinite;
      }

      .broker-status.online {
        background: #28a745;
      }

      .broker-details h3 {
        margin: 0;
        color: #2c3e50;
        font-size: 1.2em;
      }

      .broker-details p {
        margin: 5px 0 0 0;
        color: #6c757d;
        font-size: 0.9em;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 80px;
        height: 40px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #dc3545;
        transition: 0.4s;
        border-radius: 40px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 8px;
        font-size: 12px;
        color: white;
        font-weight: bold;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 32px;
        width: 32px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      input:checked + .slider {
        background-color: #28a745;
      }

      input:checked + .slider:before {
        transform: translateX(40px);
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: transform 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-2px);
      }

      .stat-card h3 {
        font-size: 2.5em;
        margin-bottom: 5px;
      }

      .stat-card p {
        font-size: 0.9em;
        opacity: 0.9;
      }

      .pending-devices {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .device-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #ffc107;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .device-info h4 {
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .device-info p {
        color: #6c757d;
        font-size: 0.9em;
      }

      .device-id {
        font-family: "Courier New", monospace;
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
      }

      .configure-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
      }

      .configure-btn:hover {
        background: #218838;
        transform: translateY(-2px);
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        margin: 5px;
      }

      .btn:hover {
        background: #0056b3;
        transform: translateY(-2px);
      }

      .btn.secondary {
        background: #6c757d;
      }

      .btn.secondary:hover {
        background: #545b62;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s;
      }

      .modal-content {
        background-color: white;
        margin: 2% auto;
        padding: 0;
        border-radius: 15px;
        width: 95%;
        max-width: 1200px;
        max-height: 90vh;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s;
        overflow: hidden;
      }

      /* üÜï NUOVO: Modal Header */
      .modal-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5em;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
        opacity: 0.8;
        transition: opacity 0.3s;
      }

      .close:hover {
        opacity: 1;
      }

      /* üÜï NUOVO: Tabs System */
      .modal-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
      }

      .tab-button {
        flex: 1;
        padding: 15px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
      }

      .tab-button.active {
        color: #667eea;
        background: white;
        border-bottom-color: #667eea;
      }

      .tab-button:hover:not(.active) {
        background: #e9ecef;
        color: #495057;
      }

      /* üÜï NUOVO: Tab Content */
      .modal-body {
        max-height: 70vh;
        overflow-y: auto;
        padding: 0;
      }

      .tab-content {
        display: none;
        padding: 30px;
      }

      .tab-content.active {
        display: block;
      }

      /* üÜï NUOVO: Readings Section (Tab 1) */
      .readings-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .register-table-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .register-table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
      }

      .register-table-header h3 {
        margin: 0;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .register-count {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
      }

      .registers-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
      }

      .registers-table th {
        background: #e9ecef;
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.85em;
      }

      .registers-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #f1f3f4;
        vertical-align: middle;
      }

      .registers-table tr:hover {
        background: #f8f9fa;
      }

      .register-address {
        font-family: "Courier New", monospace;
        background: #6c757d;
        color: white;
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 0.75em;
        font-weight: bold;
      }

      .register-name {
        font-weight: 500;
        color: #2c3e50;
      }

      .register-name.enriched {
        color: #007bff;
        border-bottom: 1px dotted #007bff;
        cursor: help;
      }

      .register-value {
        font-family: "Courier New", monospace;
        font-weight: bold;
        font-size: 1.1em;
      }

      .register-value.has-data {
        color: #28a745;
      }

      .register-value.no-data {
        color: #6c757d;
        font-style: italic;
      }

      .register-value .unit {
        font-size: 0.8em;
        color: #6c757d;
        font-style: normal;
        margin-left: 3px;
      }

      /* üÜï NUOVO: Write Section (Tab 2 & 3) */
      .write-section {
        max-width: 800px;
        margin: 0 auto;
      }

      .write-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #007bff;
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .write-item.command {
        border-left-color: #28a745;
      }

      .write-info {
        flex: 1;
      }

      .write-info h4 {
        margin: 0 0 5px 0;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .write-info p {
        margin: 0;
        color: #6c757d;
        font-size: 0.9em;
      }

      .write-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .write-input {
        width: 120px;
        padding: 8px 12px;
        border: 2px solid #e9ecef;
        border-radius: 5px;
        font-size: 0.9em;
        text-align: center;
      }

      .write-input:focus {
        outline: none;
        border-color: #007bff;
      }

      .write-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9em;
        transition: all 0.3s;
      }

      .write-btn:hover {
        background: #0056b3;
        transform: translateY(-1px);
      }

      .command-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9em;
        transition: all 0.3s;
        min-width: 100px;
      }

      .command-btn:hover {
        background: #218838;
        transform: translateY(-1px);
      }

      .command-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .table th,
      .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
      }

      .table th {
        background: #f8f9fa;
        font-weight: bold;
        color: #2c3e50;
      }

      .table tr:hover {
        background: #f8f9fa;
      }

      .status-online {
        color: #28a745;
        font-weight: bold;
      }

      .status-offline {
        color: #dc3545;
        font-weight: bold;
      }

      /* üÜï NUOVO: Device row with view button */
      .device-row {
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .device-row:hover {
        background: #f1f3f4 !important;
      }

      .view-device-btn {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85em;
        font-weight: 500;
      }

      .view-device-btn:hover {
        background: #138496;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 1001;
        animation: slideInRight 0.3s;
        max-width: 350px;
      }

      .notification.success {
        background: #28a745;
      }

      .notification.error {
        background: #dc3545;
      }

      .notification.warning {
        background: #ffc107;
        color: #000;
      }

      .notification.info {
        background: #17a2b8;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }

      .empty-state i {
        font-size: 3em;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      .template-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
      }

      .template-option {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .template-option:hover {
        border-color: #007bff;
        background: #e3f2fd;
      }

      .template-option.selected {
        border-color: #007bff;
        background: #007bff;
        color: white;
      }

      .template-option h4 {
        margin-bottom: 5px;
        font-size: 0.9em;
      }

      .template-option p {
        font-size: 0.8em;
        opacity: 0.7;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #2c3e50;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e9ecef;
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #007bff;
      }

      /* Tooltip */
      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltiptext {
        visibility: hidden;
        width: 300px;
        background-color: #2c3e50;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -150px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8em;
        line-height: 1.3;
      }

      .tooltip .tooltiptext::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #2c3e50 transparent transparent transparent;
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .modal-content {
          width: 98%;
          margin: 1% auto;
          max-height: 95vh;
        }

        .readings-section {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .device-item {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .broker-control {
          flex-direction: column;
          gap: 20px;
          text-align: center;
        }

        .write-item {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .write-controls {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>üè≠ IoT Bridge Dashboard</h1>
        <p>
          Gestione Dispositivi ESP32 & Template Configurazioni - v4.0 Con
          Scrittura Modbus
          <span class="enhanced-badge">üÜï WRITE COMMANDS</span>
        </p>
      </div>

      <!-- Controllo Broker MQTT -->
      <div class="broker-control-section">
        <div class="broker-control">
          <div class="broker-info">
            <div class="broker-status" id="brokerStatus"></div>
            <div class="broker-details">
              <h3>üåê Broker MQTT</h3>
              <p id="brokerInfo">mosquitto:1883 - Verificando...</p>
            </div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="brokerToggle" />
            <span class="slider">
              <span>OFF</span>
              <span>ON</span>
            </span>
          </label>
        </div>
      </div>

      <!-- Statistiche -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalDevices">0</h3>
          <p>Dispositivi Totali</p>
        </div>
        <div class="stat-card">
          <h3 id="pendingDevices">0</h3>
          <p>In Attesa Config</p>
        </div>
        <div class="stat-card">
          <h3 id="configuredDevices">0</h3>
          <p>Configurati Online</p>
        </div>
        <div class="stat-card">
          <h3 id="availableTemplates">0</h3>
          <p>Template Disponibili</p>
        </div>
        <div
          class="stat-card"
          onclick="showSystemDiagnostics()"
          title="Clicca per diagnostics"
        >
          <h3>üîç</h3>
          <p>Diagnostics</p>
        </div>
      </div>

      <!-- Griglia Principale -->
      <div class="grid">
        <!-- Dispositivi Pending -->
        <div class="card">
          <h2>‚è≥ Dispositivi in Attesa di Configurazione</h2>
          <button class="btn" onclick="refreshPendingDevices()">
            üîÑ Aggiorna
          </button>
          <div id="pendingDevicesContainer">
            <div class="empty-state">
              <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5">
                üì±
              </div>
              <h3>Nessun Dispositivo in Attesa</h3>
              <p>
                I nuovi dispositivi ESP32 appariranno qui quando si collegano
              </p>
            </div>
          </div>
        </div>

        <!-- Template Manager -->
        <div class="card">
          <h2>üìã Template Manager</h2>
          <button class="btn" onclick="refreshTemplates()">
            üîÑ Aggiorna Template
          </button>
          <button class="btn secondary" onclick="showTemplateInfo()">
            ‚Ñπ Info Template
          </button>
          <button class="btn secondary" onclick="showAvailableConfigs()">
            üìÅ Config Salvate
          </button>
          <div id="templatesContainer">
            <p>Caricamento template...</p>
          </div>
        </div>
      </div>

      <!-- Dispositivi Configurati -->
      <div class="pending-devices">
        <h2>‚úÖ Dispositivi Configurati e Online</h2>
        <button class="btn" onclick="refreshConfiguredDevices()">
          üîÑ Aggiorna
        </button>
        <div id="configuredDevicesContainer">
          <table class="table" id="configuredDevicesTable">
            <thead>
              <tr>
                <th>üÜî Device ID</th>
                <th>üè∑ Tipo</th>
                <th>üì° Slave Address</th>
                <th>üìä Registri</th>
                <th>üîå Stato</th>
                <th>üïê Ultimo Visto</th>
                <th>üì∂ RSSI</th>
                <th>üéÆ Azioni</th>
              </tr>
            </thead>
            <tbody id="configuredDevicesBody">
              <!-- Popolato dinamicamente -->
            </tbody>
          </table>
          <div
            id="configuredEmptyState"
            class="empty-state"
            style="display: none"
          >
            <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5">
              üîß
            </div>
            <h3>Nessun Dispositivo Configurato</h3>
            <p>I dispositivi configurati appariranno qui</p>
          </div>
        </div>
      </div>
    </div>

    <!-- üÜï NUOVO: Modal Configurazione -->
    <div id="configModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeConfigModal()">&times;</span>
        <h3>‚öô Configura Dispositivo</h3>
        <form id="configForm">
          <input type="hidden" id="deviceIdInput" />

          <div class="form-group">
            <label>üÜî Device ID:</label>
            <input type="text" id="displayDeviceId" readonly />
          </div>

          <div class="form-group">
            <label>üìã Template:</label>
            <div id="templateSelector" class="template-list">
              <!-- Popolato dinamicamente -->
            </div>
          </div>

          <div class="form-group">
            <label>üè∑ Nome Dispositivo:</label>
            <input
              type="text"
              id="deviceNameInput"
              placeholder="es: mx, dixell, carel"
              required
            />
          </div>

          <div class="form-group">
            <label>üì° Slave Address (1-247):</label>
            <input
              type="number"
              id="slaveAddressInput"
              min="1"
              max="247"
              required
            />
          </div>

          <div class="form-group">
            <label>‚ö° Baud Rate:</label>
            <select id="baudRateInput" required>
              <option value="9600">9600</option>
              <option value="19200">19200</option>
              <option value="38400">38400</option>
              <option value="57600">57600</option>
              <option value="115200">115200</option>
            </select>
          </div>

          <div style="text-align: right; margin-top: 25px">
            <button
              type="button"
              class="btn secondary"
              onclick="closeConfigModal()"
            >
              ‚ùå Annulla
            </button>
            <button type="submit" class="btn">‚úÖ Invia Configurazione</button>
          </div>
        </form>
      </div>
    </div>

    <!-- üÜï NUOVO: Modal Device Control -->
    <div id="deviceModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="deviceModalTitle">üéÆ Controllo Dispositivo</h2>
          <span class="close" onclick="closeDeviceModal()">&times;</span>
        </div>

        <!-- üÜï NUOVO: Tabs Navigation -->
        <div class="modal-tabs">
          <button class="tab-button active" onclick="switchTab('readings')">
            üìä Letture
          </button>
          <button class="tab-button" onclick="switchTab('parameters')">
            ‚úè Scrittura Parametri
          </button>
          <button class="tab-button" onclick="switchTab('commands')">
            üéÆ Comandi
          </button>
        </div>

        <div class="modal-body">
          <!-- üÜï NUOVO: Tab 1 - Readings -->
          <div id="readingsTab" class="tab-content active">
            <div class="readings-section">
              <div class="register-table-container">
                <div class="register-table-header">
                  <h3>
                    üìä Holding Registers
                    <span class="register-count" id="holdingCount">0</span>
                  </h3>
                  <button
                    class="btn"
                    onclick="refreshDeviceData()"
                    style="font-size: 0.8em; padding: 5px 10px"
                  >
                    üîÑ Aggiorna
                  </button>
                </div>
                <div id="holdingRegistersTable">
                  <div class="empty-state">
                    <p>Caricamento registri...</p>
                  </div>
                </div>
              </div>

              <div class="register-table-container">
                <div class="register-table-header">
                  <h3>
                    üîò Coils
                    <span class="register-count" id="coilsCount">0</span>
                  </h3>
                </div>
                <div id="coilsTable">
                  <div class="empty-state">
                    <p>Caricamento coils...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- üÜï NUOVO: Tab 2 - Parameters Write -->
          <div id="parametersTab" class="tab-content">
            <div class="write-section">
              <h3
                style="text-align: center; margin-bottom: 30px; color: #2c3e50"
              >
                ‚úè Scrittura Parametri
              </h3>
              <div id="parametersWriteContainer">
                <div class="empty-state">
                  <p>Caricamento parametri scrivibili...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- üÜï NUOVO: Tab 3 - Commands -->
          <div id="commandsTab" class="tab-content">
            <div class="write-section">
              <h3
                style="text-align: center; margin-bottom: 30px; color: #2c3e50"
              >
                üéÆ Comandi Predefiniti
              </h3>
              <div id="commandsContainer">
                <div class="empty-state">
                  <p>Caricamento comandi...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ‚úÖ ENHANCED: Stato dell'applicazione con controllo scrittura
      let availableTemplates = [];
      let selectedTemplate = "";
      let pendingDevices = [];
      let configuredDevices = [];
      let brokerOnline = false;
      let deviceRegisters = {}; // Cache registri per dispositivo
      let deviceConfigurations = {}; // Cache configurazioni ESSENZIALI per dispositivo
      let deviceCompleteConfigurations = {}; // üÜï Cache configurazioni COMPLETE per enrichment
      let currentDeviceId = null; // üÜï Device correntemente visualizzato nel modal
      let autoRefreshInterval = null; // üÜï Intervallo auto-refresh per device modal

      // Elementi DOM
      const brokerToggle = document.getElementById("brokerToggle");
      const brokerStatus = document.getElementById("brokerStatus");
      const brokerInfo = document.getElementById("brokerInfo");

      // üÜï ENHANCED: Funzioni per processamento valori
      function processRegisterValue(rawValue, gain, decimals, measurement) {
        if (rawValue === null || rawValue === undefined || rawValue === "--") {
          return "--";
        }

        try {
          // Applica gain e decimals
          let processedValue =
            (parseFloat(rawValue) * parseFloat(gain || 1)) /
            Math.pow(10, parseInt(decimals || 0));

          // Formatta con decimali appropriati
          if (decimals > 0) {
            processedValue = processedValue.toFixed(parseInt(decimals));
          } else {
            processedValue = Math.round(processedValue).toString();
          }

          // Aggiungi unit√† di misura se presente
          if (measurement && measurement.trim() !== "") {
            return `${processedValue} <span class="unit">${measurement.trim()}</span>`;
          }

          return processedValue;
        } catch (error) {
          console.warn("Errore processamento valore:", error);
          return rawValue;
        }
      }

      function getEnrichedRegisterName(register, completeConfig) {
        if (
          !completeConfig ||
          (!completeConfig.holding_registers && !completeConfig.coils)
        ) {
          return {
            name: register.name || `Reg${register.address}`,
            enriched: false,
            tooltip: null,
          };
        }

        // Cerca il registro nella configurazione completa
        let allRegisters = [
          ...(completeConfig.holding_registers || []),
          ...(completeConfig.coils || []),
        ];

        // ‚úÖ FIX: Cerca per address E tipo
        let completeRegister = allRegisters.find((r) => {
          // Determina il tipo atteso dal registro
          let expectedType = register.register_type || "Register";
          if (expectedType === "Coils") expectedType = "Coil";

          // Determina il tipo del registro nella config completa
          let configType = r.register_type || "Register";
          if (configType === "Coils") configType = "Coil";

          return r.address === register.address && configType === expectedType;
        });

        if (
          completeRegister &&
          completeRegister.descriptions &&
          completeRegister.descriptions.it
        ) {
          // Usa la descrizione italiana
          let tooltip = null;
          if (completeRegister.descriptions.en) {
            tooltip = `IT: ${completeRegister.descriptions.it}<br>EN: ${completeRegister.descriptions.en}`;
            if (completeRegister.measurement) {
              tooltip += `<br>Unit√†: ${completeRegister.measurement}`;
            }
            if (completeRegister.gain && completeRegister.gain !== "1") {
              tooltip += `<br>Gain: ${completeRegister.gain}`;
            }
            if (
              completeRegister.decimals &&
              completeRegister.decimals !== "0"
            ) {
              tooltip += `<br>Decimali: ${completeRegister.decimals}`;
            }
          }

          return {
            name: completeRegister.descriptions.it,
            enriched: true,
            tooltip: tooltip,
            completeData: completeRegister,
          };
        }

        // Fallback al nome originale
        return {
          name: register.name || `Reg${register.address}`,
          enriched: false,
          tooltip: null,
        };
      }

      // üÜï NUOVO: Funzioni Modal Device Control
      function openDeviceModal(deviceId) {
        currentDeviceId = deviceId;
        document.getElementById(
          "deviceModalTitle"
        ).innerHTML = `üéÆ Controllo Dispositivo - ${deviceId}`;
        document.getElementById("deviceModal").style.display = "block";

        // Reset ai tab readings
        switchTab("readings");

        // Carica dati dispositivo
        loadDeviceModalData(deviceId);

        // Avvia auto-refresh ogni 15 secondi
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }
        autoRefreshInterval = setInterval(() => {
          if (
            currentDeviceId &&
            document.getElementById("deviceModal").style.display === "block"
          ) {
            refreshDeviceData();
          }
        }, 15000);
      }

      function closeDeviceModal() {
        document.getElementById("deviceModal").style.display = "none";
        currentDeviceId = null;

        // Ferma auto-refresh
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      }

      function switchTab(tabName) {
        // Rimuovi active da tutti i tab
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        // Attiva tab selezionato
        document
          .querySelector(`button[onclick="switchTab('${tabName}')"]`)
          .classList.add("active");
        document.getElementById(`${tabName}Tab`).classList.add("active");

        // Carica contenuto specifico del tab
        if (tabName === "parameters") {
          loadParametersWriteSection();
        } else if (tabName === "commands") {
          loadCommandsSection();
        }
      }

      async function loadDeviceModalData(deviceId) {
        try {
          console.log(`üîÑ Caricamento dati modal per ${deviceId}`);

          // Carica configurazione e registri in parallelo
          await Promise.all([
            loadDeviceConfigurationForModal(deviceId),
            loadDeviceRegistersForModal(deviceId),
          ]);

          // Aggiorna UI del tab readings
          updateReadingsTabUI();
        } catch (error) {
          console.error(`‚ùå Errore caricamento dati modal ${deviceId}:`, error);
          showNotification("‚ùå Errore caricamento dati dispositivo", "error");
        }
      }

      async function loadDeviceConfigurationForModal(deviceId) {
        try {
          // Carica entrambe le configurazioni se non gi√† in cache
          if (!deviceConfigurations[deviceId]) {
            const essentialResponse = await fetch(
              `/api/device/${deviceId}/configuration?type=essential`
            );
            if (essentialResponse.ok) {
              const essentialData = await essentialResponse.json();
              if (essentialData.success) {
                deviceConfigurations[deviceId] = essentialData.configuration;
              }
            }
          }

          if (!deviceCompleteConfigurations[deviceId]) {
            const completeResponse = await fetch(
              `/api/device/${deviceId}/configuration?type=complete`
            );
            if (completeResponse.ok) {
              const completeData = await completeResponse.json();
              if (completeData.success) {
                deviceCompleteConfigurations[deviceId] =
                  completeData.configuration;
              }
            }
          }
        } catch (error) {
          console.error(
            `‚ùå Errore caricamento configurazioni ${deviceId}:`,
            error
          );
        }
      }

      async function loadDeviceRegistersForModal(deviceId) {
        try {
          const response = await fetch(`/api/device/${deviceId}/registers`);
          const data = await response.json();

          if (data.success && data.registers) {
            deviceRegisters[deviceId] = {
              data: data.registers,
              timestamp: data.timestamp || new Date().toISOString(),
              lastUpdate: new Date(),
            };
          }
        } catch (error) {
          console.error(`‚ùå Errore caricamento registri ${deviceId}:`, error);
        }
      }

      function updateReadingsTabUI() {
        if (!currentDeviceId) return;

        const deviceConfig = deviceConfigurations[currentDeviceId];
        const deviceCompleteConfig =
          deviceCompleteConfigurations[currentDeviceId];
        const deviceReadings = deviceRegisters[currentDeviceId];

        if (!deviceConfig) {
          document.getElementById("holdingRegistersTable").innerHTML =
            '<div class="empty-state"><p>Configurazione non disponibile</p></div>';
          document.getElementById("coilsTable").innerHTML =
            '<div class="empty-state"><p>Configurazione non disponibile</p></div>';
          return;
        }

        // üÜï NUOVO: Usa composite_key dal firmware se disponibile
        const readingsMap = {};
        if (
          deviceReadings &&
          deviceReadings.data &&
          deviceReadings.data.registers
        ) {
          deviceReadings.data.registers.forEach((reg) => {
            // üÜï PRIORIT√Ä 1: Usa composite_key dal firmware se disponibile (nuovo sistema)
            if (reg.composite_key) {
              readingsMap[reg.composite_key] = reg.value;
              console.log(
                `üîë Usando composite_key: ${reg.composite_key} = ${reg.value}`
              );
            }

            // üÜï PRIORIT√Ä 2: Mantieni anche il vecchio sistema per retrocompatibilit√†
            const compositeKey = `${reg.address}_${reg.type || "Register"}`;
            readingsMap[compositeKey] = reg.value;

            // üÜï PRIORIT√Ä 3: Chiave semplice per backward compatibility
            if (!readingsMap.hasOwnProperty(reg.address)) {
              readingsMap[reg.address] = reg.value;
            }
          });
        }

        // Aggiorna contatori
        document.getElementById("holdingCount").textContent = (
          deviceConfig.holding_registers || []
        ).length;
        document.getElementById("coilsCount").textContent = (
          deviceConfig.coils || []
        ).length;

        // Genera tabelle con chiave composita
        updateRegisterTable(
          "holdingRegistersTable",
          deviceConfig.holding_registers || [],
          readingsMap,
          deviceCompleteConfig,
          "Register" // ‚úÖ NUOVO: Passa il tipo
        );

        updateRegisterTable(
          "coilsTable",
          deviceConfig.coils || [],
          readingsMap,
          deviceCompleteConfig,
          "Coil" // ‚úÖ NUOVO: Passa il tipo
        );
      }

      // ‚úÖ FIX: Modifica updateRegisterTable per usare tipo
      function updateRegisterTable(
        containerId,
        registers,
        readingsMap,
        completeConfig,
        registerType
      ) {
        const container = document.getElementById(containerId);

        if (registers.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><p>Nessun registro configurato</p></div>';
          return;
        }

        let tableHTML = `
    <table class="registers-table">
        <thead>
            <tr>
                <th>üìç Addr</th>
                <th>üè∑ Nome</th>
                <th>üìà Valore</th>
                <th>üîß Tipo</th>
            </tr>
        </thead>
        <tbody>
`;

        registers.forEach((reg) => {
          // üÜï FIX: Usa solo chiavi specifiche, NO fallback alla chiave semplice
          let hasValue = false;
          let rawValue = "--";

          // Prova prima composite_key dal firmware (priorit√† massima)
          const expectedCompositeKey = `${reg.address}_${registerType}`;
          if (readingsMap.hasOwnProperty(expectedCompositeKey)) {
            hasValue = true;
            rawValue = readingsMap[expectedCompositeKey];
            console.log(
              `‚úÖ Trovato valore per ${expectedCompositeKey}: ${rawValue}`
            );
          }
          // ‚ùå RIMUOVO IL FALLBACK PROBLEMATICO che causava la condivisione valori
          else {
            console.log(`‚ö†Ô∏è Nessun valore trovato per ${expectedCompositeKey}`);
          }

          // Enrichment nome e valore
          const enrichedName = getEnrichedRegisterName(reg, completeConfig);

          let displayValue = rawValue;
          if (
            hasValue &&
            rawValue !== "--" &&
            completeConfig &&
            enrichedName.completeData
          ) {
            const completeReg = enrichedName.completeData;
            displayValue = processRegisterValue(
              rawValue,
              completeReg.gain,
              completeReg.decimals,
              completeReg.measurement
            );
          }

          const valueClass =
            hasValue && rawValue !== "--" ? "has-data" : "no-data";

          // ‚úÖ FIX: Mostra chiaramente il tipo del registro
          const displayType =
            registerType === "Register" ? "üìä Register" : "üîò Coil";

          tableHTML += `
        <tr>
            <td><span class="register-address">${reg.address}</span></td>
            <td>
                ${
                  enrichedName.tooltip
                    ? `<div class="tooltip">
                    <span class="register-name ${
                      enrichedName.enriched ? "enriched" : ""
                    }">${enrichedName.name}</span>
                    <span class="tooltiptext">${enrichedName.tooltip}</span>
                   </div>`
                    : `<span class="register-name ${
                        enrichedName.enriched ? "enriched" : ""
                      }">${enrichedName.name}</span>`
                }
            </td>
            <td><span class="register-value ${valueClass}">${displayValue}</span></td>
            <td><span style="font-size: 0.8em; color: #6c757d;">${displayType}</span></td>
        </tr>
    `;
        });

        tableHTML += "</tbody></table>";
        container.innerHTML = tableHTML;
      }

      async function refreshDeviceData() {
        if (!currentDeviceId) return;

        console.log(`üîÑ Refresh dati per ${currentDeviceId}`);
        await loadDeviceRegistersForModal(currentDeviceId);
        updateReadingsTabUI();

        showNotification("‚úÖ Dati aggiornati", "success");
      }

      async function loadParametersWriteSection() {
        if (!currentDeviceId) return;

        const container = document.getElementById("parametersWriteContainer");
        const deviceConfig = deviceConfigurations[currentDeviceId];
        const completeConfig = deviceCompleteConfigurations[currentDeviceId];

        if (!deviceConfig || !deviceConfig.holding_registers) {
          container.innerHTML =
            '<div class="empty-state"><p>Nessun parametro scrivibile configurato</p></div>';
          return;
        }

        // ‚úÖ FIX: Filtra SOLO gli holding registers (non i coils)
        const writableRegisters = deviceConfig.holding_registers.filter(
          (reg) => {
            // Verifica che sia davvero un registro (non un coil con stesso indirizzo)
            return reg.register_type === "Register" || !reg.register_type;
          }
        );

        if (writableRegisters.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><p>Nessun parametro scrivibile</p></div>';
          return;
        }

        let html = "";
        writableRegisters.forEach((reg) => {
          const enrichedName = getEnrichedRegisterName(reg, completeConfig);
          const registerId = `write_reg_${reg.address}`;

          html += `
            <div class="write-item">
                <div class="write-info">
                    <h4>
                        <span class="register-address">${reg.address}</span>
                        ${enrichedName.name}
                        <span style="font-size: 0.8em; color: #007bff;">üìä Register</span>
                    </h4>
                    <p>${
                      enrichedName.tooltip
                        ? enrichedName.tooltip.replace(/<br>/g, " | ")
                        : "Registro Modbus scrivibile"
                    }</p>
                </div>
                <div class="write-controls">
                    <input 
                        type="number" 
                        class="write-input" 
                        id="${registerId}_input"
                        placeholder="Valore..."
                        min="0" 
                        max="65535"
                    />
                    <button 
                        class="write-btn" 
                        onclick="writeRegister(${
                          reg.address
                        }, '${registerId}_input', '${enrichedName.name.replace(
            /'/g,
            "\\'"
          )}')"
                    >
                        ‚úèÔ∏è Scrivi Reg
                    </button>
                </div>
            </div>
        `;
        });

        container.innerHTML = html;
      }

      async function loadCommandsSection() {
        if (!currentDeviceId) return;

        const container = document.getElementById("commandsContainer");
        const completeConfig = deviceCompleteConfigurations[currentDeviceId];

        if (
          !completeConfig ||
          !completeConfig.commands ||
          completeConfig.commands.length === 0
        ) {
          container.innerHTML =
            '<div class="empty-state"><p>Nessun comando configurato</p></div>';
          return;
        }

        let html = "";
        completeConfig.commands.forEach((cmd) => {
          const commandName =
            cmd.descriptions && cmd.descriptions.it
              ? cmd.descriptions.it
              : cmd.name;
          const commandDesc =
            cmd.descriptions && cmd.descriptions.en
              ? cmd.descriptions.en
              : "Comando Modbus";
          const buttonText = cmd.html_button_description
            ? JSON.parse(cmd.html_button_description.replace(/&quot;/g, '"'))
                .it || cmd.name
            : cmd.name;

          html += `
            <div class="write-item command">
              <div class="write-info">
                <h4>
                  <span class="register-address">${cmd.address}</span>
                  ${commandName}
                </h4>
                <p>${commandDesc} (Valore: ${cmd.value_command})</p>
              </div>
              <div class="write-controls">
                <button 
                  class="command-btn" 
                  onclick="sendCommand('${cmd.name}', ${cmd.address}, ${
            cmd.value_command
          }, '${cmd.alias || cmd.name}', '${commandDesc.replace(/'/g, "\\'")}')"
                >
                  üéÆ ${buttonText}
                </button>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      // üÜï NUOVO: Funzioni di scrittura Modbus
      async function writeRegister(address, inputId, registerName) {
        const input = document.getElementById(inputId);
        const value = parseInt(input.value);

        if (isNaN(value) || value < 0 || value > 65535) {
          showNotification("‚ùå Valore non valido (0-65535)", "error");
          return;
        }

        try {
          const response = await fetch(
            `/api/device/${currentDeviceId}/write_register`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                address: address,
                value: value,
                register_name: registerName,
              }),
            }
          );

          const data = await response.json();

          if (data.success) {
            showNotification(
              `‚úÖ Registro ${address} scritto: ${value}`,
              "success"
            );
            input.value = ""; // Pulisci input

            // Refresh automatico dopo 2 secondi
            setTimeout(() => refreshDeviceData(), 2000);
          } else {
            showNotification(`‚ùå Errore scrittura: ${data.error}`, "error");
          }
        } catch (error) {
          console.error("Errore scrittura registro:", error);
          showNotification("‚ùå Errore connessione", "error");
        }
      }

      async function sendCommand(
        commandName,
        address,
        valueCommand,
        alias,
        description
      ) {
        try {
          const response = await fetch(
            `/api/device/${currentDeviceId}/send_command`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                command_name: commandName,
                address: address,
                value_command: valueCommand,
                alias: alias,
                description: description,
              }),
            }
          );

          const data = await response.json();

          if (data.success) {
            showNotification(`‚úÖ Comando "${commandName}" inviato`, "success");

            // Refresh automatico dopo 2 secondi
            setTimeout(() => refreshDeviceData(), 2000);
          } else {
            showNotification(`‚ùå Errore comando: ${data.error}`, "error");
          }
        } catch (error) {
          console.error("Errore invio comando:", error);
          showNotification("‚ùå Errore connessione", "error");
        }
      }

      // Inizializzazione
      document.addEventListener("DOMContentLoaded", function () {
        console.log(
          "üöÄ Dashboard Enhanced inizializzata - VERSIONE 4.0 con Scrittura Modbus"
        );

        // Setup form submit
        document
          .getElementById("configForm")
          .addEventListener("submit", handleConfigSubmit);

        // Setup broker toggle
        brokerToggle.addEventListener("change", toggleBroker);

        // Carica dati iniziali
        refreshAll();
        checkBrokerStatus();

        // Auto-refresh ogni 5 secondi
        setInterval(refreshAll, 5000);

        // Controlla stato broker ogni 30 secondi
        setInterval(checkBrokerStatus, 30000);
      });

      async function refreshAll() {
        console.log("üîÑ Refresh completo...");

        try {
          await Promise.all([
            refreshPendingDevices(),
            refreshConfiguredDevices(),
            refreshTemplates(),
          ]);

          updateStats();
          console.log("‚úÖ Refresh completato");
        } catch (error) {
          console.error("Errore durante refresh:", error);
          showNotification("‚ö† Errore aggiornamento dati", "warning");
        }
      }

      async function refreshPendingDevices() {
        try {
          console.log("üîÑ Caricamento dispositivi pending...");
          const response = await fetch("/api/pending_devices");
          const data = await response.json();

          if (data.success) {
            pendingDevices = data.devices || [];
            console.log(
              `‚úÖ Caricati ${pendingDevices.length} dispositivi pending:`,
              pendingDevices
            );
            updatePendingDevicesUI();
          } else {
            console.error("Errore caricamento pending devices:", data.error);
            showNotification(
              "‚ùå Errore caricamento pending: " + data.error,
              "error"
            );
          }
        } catch (error) {
          console.error("Errore fetch pending devices:", error);
          showNotification("‚ùå Errore connessione pending devices", "error");
        }
      }

      async function refreshConfiguredDevices() {
        try {
          console.log("üîÑ Caricamento dispositivi configurati...");
          const response = await fetch("/api/configured_devices");
          const data = await response.json();

          configuredDevices = data.devices || [];
          console.log(
            `‚úÖ Caricati ${configuredDevices.length} dispositivi configurati:`,
            configuredDevices
          );
          updateConfiguredDevicesUI();
        } catch (error) {
          console.error("Errore fetch configured devices:", error);
          configuredDevices = [];
          updateConfiguredDevicesUI();
        }
      }

      async function refreshTemplates() {
        try {
          console.log("üîÑ Caricamento template...");
          const response = await fetch("/api/available_templates");
          const data = await response.json();

          if (data.success) {
            availableTemplates = data.templates || [];
            console.log(
              `‚úÖ Caricati ${availableTemplates.length} template:`,
              availableTemplates
            );
            updateTemplatesUI();
          } else {
            console.error("Errore caricamento template:", data.error);
            showNotification(
              "‚ùå Errore caricamento template: " + data.error,
              "error"
            );
          }
        } catch (error) {
          console.error("Errore fetch template:", error);
          showNotification("‚ùå Errore connessione template", "error");
        }
      }

      async function updateStats() {
        try {
          const response = await fetch("/api/dashboard_stats");
          const data = await response.json();

          if (data.success) {
            const stats = data.stats;
            document.getElementById("pendingDevices").textContent =
              stats.pending_count || pendingDevices.length;
            document.getElementById("configuredDevices").textContent =
              stats.configured_count || configuredDevices.length;
            document.getElementById("totalDevices").textContent =
              (stats.pending_count || 0) + (stats.configured_count || 0);
            document.getElementById("availableTemplates").textContent =
              availableTemplates.length;
          } else {
            // Fallback alle statistiche locali
            document.getElementById("pendingDevices").textContent =
              pendingDevices.length;
            document.getElementById("configuredDevices").textContent =
              configuredDevices.length;
            document.getElementById("totalDevices").textContent =
              pendingDevices.length + configuredDevices.length;
            document.getElementById("availableTemplates").textContent =
              availableTemplates.length;
          }
        } catch (error) {
          // Fallback alle statistiche locali
          document.getElementById("pendingDevices").textContent =
            pendingDevices.length;
          document.getElementById("configuredDevices").textContent =
            configuredDevices.length;
          document.getElementById("totalDevices").textContent =
            pendingDevices.length + configuredDevices.length;
          document.getElementById("availableTemplates").textContent =
            availableTemplates.length;
        }
      }

      // Controllo Broker
      async function checkBrokerStatus() {
        try {
          const response = await fetch("/api/broker/status");
          const data = await response.json();

          brokerOnline = data.running || false;
          updateBrokerUI();

          console.log(
            `üåê Stato Broker: ${brokerOnline ? "Online" : "Offline"}`
          );
        } catch (error) {
          console.error("Errore controllo stato broker:", error);
          brokerOnline = false;
          updateBrokerUI();
        }
      }

      async function toggleBroker() {
        const isChecked = brokerToggle.checked;

        try {
          brokerToggle.disabled = true;

          if (isChecked) {
            showNotification("üöÄ Avviando broker MQTT...", "info");
            const response = await fetch("/api/broker/start", {
              method: "POST",
            });
            const data = await response.json();

            if (data.success) {
              brokerOnline = true;
              updateBrokerUI();
              showNotification(
                "‚úÖ Broker MQTT avviato con successo!",
                "success"
              );
            } else {
              throw new Error(data.error || "Errore avvio broker");
            }
          } else {
            showNotification("üõë Fermando broker MQTT...", "info");
            const response = await fetch("/api/broker/stop", {
              method: "POST",
            });
            const data = await response.json();

            if (data.success) {
              brokerOnline = false;
              updateBrokerUI();
              showNotification("üõë Broker MQTT fermato", "info");
            } else {
              throw new Error(data.error || "Errore stop broker");
            }
          }
        } catch (error) {
          console.error("Errore toggle broker:", error);
          showNotification("‚ùå Errore: " + error.message, "error");

          // Ripristina stato precedente
          brokerToggle.checked = brokerOnline;
        } finally {
          brokerToggle.disabled = false;
        }
      }

      function updateBrokerUI() {
        brokerToggle.checked = brokerOnline;

        if (brokerOnline) {
          brokerStatus.classList.add("online");
          brokerInfo.textContent = "mosquitto:1883 - Online ‚úÖ";
        } else {
          brokerStatus.classList.remove("online");
          brokerInfo.textContent = "mosquitto:1883 - Offline ‚ùå";
        }
      }

      // UI Updates
      function updatePendingDevicesUI() {
        const container = document.getElementById("pendingDevicesContainer");

        console.log(
          `üîÑ Aggiornamento UI: ${pendingDevices.length} dispositivi pending`
        );

        if (pendingDevices.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;">üì±</div>
                        <h3>Nessun Dispositivo in Attesa</h3>
                        <p>I nuovi dispositivi ESP32 appariranno qui quando si collegano</p>
                    </div>
                `;
        } else {
          container.innerHTML = pendingDevices
            .map(
              (device) => `
                    <div class="device-item">
                        <div class="device-info">
                            <h4>üì± <span class="device-id">${
                              device.device_id
                            }</span></h4>
                            <p>üîå Status: ${device.status}</p>
                            <p>üì∂ RSSI: ${device.wifi_rssi} dBm</p>
                            <p>üïê Rilevato: ${formatLastSeen(
                              device.minutes_ago
                            )} fa</p>
                        </div>
                        <button class="configure-btn" onclick="openConfigModal('${
                          device.device_id
                        }')">
                            ‚öô Configura
                        </button>
                    </div>
                `
            )
            .join("");
        }
      }

      function updateTemplatesUI() {
        const container = document.getElementById("templatesContainer");

        if (availableTemplates.length === 0) {
          container.innerHTML = "<p>‚ùå Nessun template disponibile</p>";
        } else {
          container.innerHTML = `
                    <p>üìÅ Template disponibili: <strong>${
                      availableTemplates.length
                    }</strong></p>
                    <div style="margin-top: 10px;">
                        ${availableTemplates
                          .map(
                            (template) => `
                            <span style="background: #e9ecef; padding: 5px 10px; border-radius: 15px; margin: 2px; display: inline-block; font-size: 0.9em;">
                                üìã ${template}
                            </span>
                        `
                          )
                          .join("")}
                    </div>
                `;
        }
      }

      function updateConfiguredDevicesUI() {
        const tbody = document.getElementById("configuredDevicesBody");
        const table = document.getElementById("configuredDevicesTable");
        const emptyState = document.getElementById("configuredEmptyState");

        console.log(
          `üîÑ Aggiornamento UI: ${configuredDevices.length} dispositivi configurati`
        );

        if (configuredDevices.length === 0) {
          table.style.display = "none";
          emptyState.style.display = "block";
          return;
        }

        table.style.display = "table";
        emptyState.style.display = "none";

        tbody.innerHTML = configuredDevices
          .map(
            (device, index) => `
                <tr class="device-row" id="device-row-${index}">
                    <td><span class="device-id">${device.device_id}</span></td>
                    <td><span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${device.device_type.toUpperCase()}</span></td>
                    <td>${device.slave_address}</td>
                    <td>${device.total_registers}</td>
                    <td><span class="status-${
                      device.status
                    }">${device.status.toUpperCase()}</span></td>
                    <td>${formatLastSeen(device.minutes_ago)}</td>
                    <td>${device.wifi_rssi} dBm</td>
                    <td>
                        <button class="view-device-btn" onclick="openDeviceModal('${
                          device.device_id
                        }')">
                            üéÆ Controlla
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      // ‚úÖ ENHANCED: Funzioni diagnostics
      async function showSystemDiagnostics() {
        try {
          const [templatesResponse, configsResponse] = await Promise.all([
            fetch("/api/available_templates"),
            fetch("/api/available_configs"),
          ]);

          const templatesData = await templatesResponse.json();
          const configsData = await configsResponse.json();

          const diagnosticsInfo = `
üìä DIAGNOSTICS SISTEMA IoT v4.0 CON SCRITTURA MODBUS

üìÅ TEMPLATE XML DISPONIBILI (${templatesData.templates?.length || 0}):
${
  templatesData.templates
    ?.map((template) => `‚Ä¢ ${template.toUpperCase()}`)
    .join("\n") || "‚Ä¢ Nessun template"
}

üìÅ CONFIGURAZIONI JSON SALVATE (${configsData.count || 0}):
Directory: ${configsData.directory || "/app/templates/json"}
‚Ä¢ Essential configs: ${configsData.essential_count || 0} (per ESP32)
‚Ä¢ Complete configs: ${configsData.complete_count || 0} (per Dashboard)
${
  configsData.configs
    ?.slice(0, 5)
    .map(
      (config) =>
        `‚Ä¢ ${config.filename} - ${config.config_type} - ${config.device}_${config.slave_address} (${config.total_registers} registri)`
    )
    .join("\n") || "‚Ä¢ Nessuna configurazione salvata"
}

üì± DISPOSITIVI ATTIVI (${configuredDevices.length}):
${
  configuredDevices
    .map(
      (device) =>
        `‚Ä¢ ${device.device_id} - ${device.device_type} (${device.total_registers} registri) - ${device.status}`
    )
    .join("\n") || "‚Ä¢ Nessun dispositivo configurato"
}

üÜï SCRITTURA MODBUS STATUS:
‚Ä¢ Write Register API: ‚úÖ Attivo
‚Ä¢ Write Coil API: ‚úÖ Attivo  
‚Ä¢ Send Command API: ‚úÖ Attivo
‚Ä¢ Modal UI: ‚úÖ Implementato
‚Ä¢ Auto-refresh: ‚úÖ Attivo (15s)

‚öô STATO SISTEMA:
‚Ä¢ Broker MQTT: ${brokerOnline ? "Online" : "Offline"}
‚Ä¢ Dispositivi Pending: ${pendingDevices.length}
‚Ä¢ Modal aperto: ${currentDeviceId || "Nessuno"}
‚Ä¢ Auto-refresh attivo: ${autoRefreshInterval ? "S√¨" : "No"}

üí° TROUBLESHOOTING:
‚Ä¢ Se comandi non funzionano ‚Üí Verifica ESP32 firmware aggiornato
‚Ä¢ Se scrittura fallisce ‚Üí Controlla log MQTT bridge
‚Ä¢ Per test scrittura ‚Üí Usa tab "Scrittura Parametri" e "Comandi"
‚Ä¢ Directory configs: /app/templates/json (dual storage)

üîß DEBUG INFO:
‚Ä¢ Template da XML: ${templatesData.success ? "‚úÖ" : "‚ùå"}
‚Ä¢ Config JSON: ${configsData.success ? "‚úÖ" : "‚ùå"}
‚Ä¢ Write Commands: ‚úÖ Dashboard + Backend + Bridge pronti
                `;

          alert(diagnosticsInfo);
        } catch (error) {
          console.error("Errore diagnostics:", error);
          alert("Errore caricamento diagnostics: " + error.message);
        }
      }

      async function showAvailableConfigs() {
        try {
          const response = await fetch("/api/available_configs");
          const data = await response.json();

          if (data.success) {
            const configsInfo = `
üìÅ CONFIGURAZIONI JSON DUAL SALVATE (${data.count})

Directory: ${data.directory}

üîß ESSENTIAL CONFIGS (${data.essential_count}): Per ESP32
${
  data.essential_configs
    ?.map(
      (config) =>
        `üìÑ ${config.filename}
   ‚Ä¢ Device: ${config.device}_${config.slave_address}
   ‚Ä¢ Registri: ${config.total_registers}
   ‚Ä¢ Dimensione: ${(config.file_size / 1024).toFixed(1)} KB`
    )
    .join("\n\n") || "‚Ä¢ Nessuna configurazione essential"
}

üìä COMPLETE CONFIGS (${data.complete_count}): Per Dashboard Enrichment
${
  data.complete_configs
    ?.map(
      (config) =>
        `üìÑ ${config.filename}
   ‚Ä¢ Device: ${config.device}_${config.slave_address}
   ‚Ä¢ Registri: ${config.total_registers}
   ‚Ä¢ Dimensione: ${(config.file_size / 1024).toFixed(1)} KB
   ‚Ä¢ Version: ${config.version}`
    )
    .join("\n\n") || "‚Ä¢ Nessuna configurazione completa"
}

üÜï FUNZIONALIT√Ä SCRITTURA:
‚Ä¢ Le configurazioni complete includono sezione Commands
‚Ä¢ Modal UI permette scrittura parametri e invio comandi
‚Ä¢ Feedback real-time tramite notifiche
                    `;
            alert(configsInfo);
          } else {
            alert("Errore caricamento configurazioni: " + data.error);
          }
        } catch (error) {
          alert("Errore connessione: " + error.message);
        }
      }

      // Utility functions
      function formatLastSeen(minutesAgo) {
        if (minutesAgo < 1) return "< 1 min";
        else if (minutesAgo < 60) return `${Math.floor(minutesAgo)} min`;
        else return `${Math.floor(minutesAgo / 60)}h`;
      }

      // Modal functions
      function openConfigModal(deviceId) {
        document.getElementById("deviceIdInput").value = deviceId;
        document.getElementById("displayDeviceId").value = deviceId;

        // Popola template selector
        const templateSelector = document.getElementById("templateSelector");
        templateSelector.innerHTML = availableTemplates
          .map(
            (template) => `
                <div class="template-option" onclick="selectTemplate('${template}')">
                    <h4>${template.toUpperCase()}</h4>
                    <p>Template XML ‚Üí Dual JSON</p>
                </div>
            `
          )
          .join("");

        // Reset form
        selectedTemplate = "";
        document.getElementById("deviceNameInput").value = "";
        document.getElementById("slaveAddressInput").value = "";
        document.getElementById("baudRateInput").value = "19200";

        document.getElementById("configModal").style.display = "block";
      }

      function closeConfigModal() {
        document.getElementById("configModal").style.display = "none";
      }

      function selectTemplate(template) {
        selectedTemplate = template;

        // Aggiorna UI selezione
        document.querySelectorAll(".template-option").forEach((option) => {
          option.classList.remove("selected");
        });

        event.target.closest(".template-option").classList.add("selected");

        // Auto-popola nome dispositivo
        document.getElementById("deviceNameInput").value = template;
      }

      async function handleConfigSubmit(event) {
        event.preventDefault();

        if (!selectedTemplate) {
          showNotification("‚ö† Seleziona un template", "warning");
          return;
        }

        const configData = {
          device_id: document.getElementById("deviceIdInput").value,
          template: selectedTemplate,
          device_name: document.getElementById("deviceNameInput").value,
          slave_address: parseInt(
            document.getElementById("slaveAddressInput").value
          ),
          baud_rate: parseInt(document.getElementById("baudRateInput").value),
        };

        try {
          showNotification("‚è≥ Generando configurazioni DUAL...", "info");

          const response = await fetch("/api/generate_and_send_config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(configData),
          });

          const data = await response.json();

          if (data.success) {
            const message = `‚úÖ Configurazioni DUAL generate! 
üìä Essential: ${data.essential_config?.saved_file || "N/A"} 
üîß Complete: ${data.complete_config?.saved_file || "N/A"}`;
            showNotification(message, "success");
            closeConfigModal();

            // Refresh dopo 2 secondi
            setTimeout(() => {
              refreshAll();
            }, 2000);
          } else {
            showNotification("‚ùå Errore: " + data.error, "error");
          }
        } catch (error) {
          console.error("Errore invio configurazione:", error);
          showNotification("‚ùå Errore connessione", "error");
        }
      }

      function showTemplateInfo() {
        if (availableTemplates.length === 0) {
          showNotification("‚Ñπ Nessun template caricato", "info");
          return;
        }

        const info = `üìã Template XML Disponibili:

${availableTemplates.map((t) => `‚Ä¢ ${t.toUpperCase()}`).join("\n")}

üìÅ Directory: /app/templates/xml/
üíæ I file JSON vengono salvati automaticamente in: /app/templates/json/

üÜï DUAL FILE GENERATION:
‚Ä¢ Essential JSON: per ESP32 (ottimizzato, solo campi necessari)
‚Ä¢ Complete JSON: per Dashboard (tutti i parametri + Commands per scrittura)

üéÆ SCRITTURA MODBUS:
‚Ä¢ I template includono sezione Commands per controllo dispositivi
‚Ä¢ Modal UI permette scrittura parametri e invio comandi

Per aggiungere nuovi template:
1. Aggiungi file XML nella cartella templates/xml/
2. Riavvia il container config-service
3. I template appariranno nella dashboard`;
        alert(info);
      }

      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideInRight 0.3s reverse";
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 4000);
      }

      // Chiudi modal cliccando fuori
      window.onclick = function (event) {
        const configModal = document.getElementById("configModal");
        const deviceModal = document.getElementById("deviceModal");

        if (event.target === configModal) {
          closeConfigModal();
        }
        if (event.target === deviceModal) {
          closeDeviceModal();
        }
      };

      console.log(
        "üè≠ IoT Bridge Dashboard Enhanced caricata - VERSIONE 4.0 CON SCRITTURA MODBUS"
      );
      console.log(
        "üÜï Funzionalit√† Enhanced: Dual Config Generation + Dashboard Enrichment + Write Commands"
      );
    </script>
  </body>
</html>
